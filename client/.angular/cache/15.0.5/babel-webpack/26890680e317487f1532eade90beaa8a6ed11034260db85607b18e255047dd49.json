{"ast":null,"code":"import _asyncToGenerator from \"/Users/godwinonah/Documents/BagShop-Client-App/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { loadStripe } from '@stripe/stripe-js';\nimport { firstValueFrom } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"app/basket/basket.service\";\nimport * as i2 from \"../../checkout-service.service\";\nimport * as i3 from \"ngx-toastr\";\nimport * as i4 from \"@angular/router\";\nimport * as i5 from \"@angular/common\";\nimport * as i6 from \"@angular/forms\";\nimport * as i7 from \"../../../Account/text-inputs/text-inputs.component\";\nimport * as i8 from \"@angular/cdk/stepper\";\nconst _c0 = [\"cardNumber\"];\nconst _c1 = [\"cardExpiry\"];\nconst _c2 = [\"cardCvc\"];\nfunction CheckoutPaymentComponent_div_0_i_26_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"i\", 25);\n  }\n}\nfunction CheckoutPaymentComponent_div_0_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r6 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 9)(1, \"div\", 10)(2, \"div\", 11);\n    i0.ɵɵelement(3, \"app-text-inputs\", 12);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(4, \"div\", 13)(5, \"div\", 14)(6, \"div\", 15);\n    i0.ɵɵelement(7, \"div\", 16, 17);\n    i0.ɵɵelementStart(9, \"label\");\n    i0.ɵɵtext(10, \"Card Number\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(11, \"span\", 18);\n    i0.ɵɵtext(12);\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(13, \"div\", 19)(14, \"div\", 15);\n    i0.ɵɵelement(15, \"div\", 16, 20);\n    i0.ɵɵelementStart(17, \"label\");\n    i0.ɵɵtext(18, \"Card Expiry\");\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(19, \"div\", 19)(20, \"div\", 15);\n    i0.ɵɵelement(21, \"div\", 16, 21);\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(23, \"div\", 22)(24, \"button\", 23);\n    i0.ɵɵlistener(\"click\", function CheckoutPaymentComponent_div_0_Template_button_click_24_listener() {\n      i0.ɵɵrestoreView(_r6);\n      const ctx_r5 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r5.OrderSubmission());\n    });\n    i0.ɵɵtext(25, \" Submit \");\n    i0.ɵɵtemplate(26, CheckoutPaymentComponent_div_0_i_26_Template, 1, 0, \"i\", 24);\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵproperty(\"formGroup\", ctx_r0.checkOutForm);\n    i0.ɵɵadvance(12);\n    i0.ɵɵtextInterpolate(ctx_r0.cardErrors);\n    i0.ɵɵadvance(12);\n    i0.ɵɵproperty(\"disabled\", ctx_r0.loading || !ctx_r0.paymentIsComplete);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngIf\", ctx_r0.loading);\n  }\n}\nexport class CheckoutPaymentComponent {\n  constructor(basketService, checkOutService, toastr, router) {\n    this.basketService = basketService;\n    this.checkOutService = checkOutService;\n    this.toastr = toastr;\n    this.router = router;\n    this.errors = null;\n    this.stripe = null;\n    this.cardNumberComplete = false;\n    this.cardExpiryComplete = false;\n    this.cvcComplete = false;\n    this.loading = false;\n  }\n  ngOnInit() {\n    this.year = new Date().getFullYear();\n    this.yearSub = Number(this.year.toString().substring(2, 4));\n    loadStripe('pk_test_51Mcx2FB7QPlKfZO42IAdvFhiWvLmJJqyarpwQZYE8Mes7QioM5QNIme3OPI0KBP7tnLRf43CLRSzmCa0xzv37VmJ00VDpXrD7T').then(stripe => {\n      this.stripe = stripe;\n      const elements = stripe?.elements();\n      if (elements) {\n        this.cardNumber = elements.create('cardNumber');\n        this.cardNumber.mount(this.cardNumberElement?.nativeElement);\n        this.cardNumber.on('change', event => {\n          this.cardNumberComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;else {\n            this.cardErrors = null;\n          }\n        });\n        this.cardExpiry = elements.create('cardExpiry');\n        this.cardExpiry.mount(this.cardExpiryElement?.nativeElement);\n        this.cardExpiry.on('change', event => {\n          this.cardExpiryComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;else {\n            this.cardErrors = null;\n          }\n        });\n        this.cvc = elements.create('cardCvc');\n        this.cvc.mount(this.cvcElement?.nativeElement);\n        this.cvc.on('change', event => {\n          this.cvcComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;else {\n            this.cardErrors = null;\n          }\n        });\n      }\n    });\n  }\n  get paymentIsComplete() {\n    return this.checkOutForm.get('paymentForm')?.valid && this.cardNumberComplete && this.cardExpiryComplete && this.cvcComplete;\n  }\n  ConfirmPaymentUsingStripe(basket) {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      if (!basket) throw new Error('basket is null');\n      const result = _this.stripe?.confirmCardPayment(basket.clientSecret, {\n        payment_method: {\n          card: _this.cardNumber,\n          billing_details: {\n            name: _this.checkOutForm?.get('paymentForm')?.get('nameOnCard')?.value\n          }\n        }\n      });\n      if (!result) throw new Error('problem confirming problem with stripe');\n      return result;\n    })();\n  }\n  GetOrderDetails(basket) {\n    const shippingAddress = this.checkOutForm?.get('addressForm')?.value;\n    if (!shippingAddress) throw new Error('No Address added');\n    return {\n      basketId: basket.id,\n      deliveryId: basket.deliveryId,\n      shippingAddress: shippingAddress\n    };\n  }\n  CreateOrder(basket) {\n    var _this2 = this;\n    return _asyncToGenerator(function* () {\n      if (!basket) throw new Error('basket is null');\n      const orderToCreate = _this2.GetOrderDetails(basket);\n      return firstValueFrom(_this2.checkOutService.CreateAnOrder(orderToCreate));\n      ;\n    })();\n  }\n  OrderSubmission() {\n    var _this3 = this;\n    return _asyncToGenerator(function* () {\n      _this3.loading = true;\n      const basket = _this3.basketService.CurrentBasket();\n      if (!basket) throw new Error(\"Cannot get basket\");\n      try {\n        const createdOrder = yield _this3.CreateOrder(basket);\n        const paymentResult = yield _this3.ConfirmPaymentUsingStripe(basket);\n        if (paymentResult.paymentIntent) {\n          _this3.basketService.DeleteBasket(basket);\n          const navigationExtras = {\n            state: createdOrder\n          };\n          _this3.router.navigate(['Checkout/success'], navigationExtras);\n        } else {\n          _this3.toastr.error(paymentResult.error.message);\n        }\n      } catch (error) {\n        _this3.toastr.error(error.message);\n      } finally {\n        _this3.loading = false;\n      }\n    })();\n  }\n}\nCheckoutPaymentComponent.ɵfac = function CheckoutPaymentComponent_Factory(t) {\n  return new (t || CheckoutPaymentComponent)(i0.ɵɵdirectiveInject(i1.BasketService), i0.ɵɵdirectiveInject(i2.CheckoutServiceService), i0.ɵɵdirectiveInject(i3.ToastrService), i0.ɵɵdirectiveInject(i4.Router));\n};\nCheckoutPaymentComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: CheckoutPaymentComponent,\n  selectors: [[\"app-checkout-payment\"]],\n  viewQuery: function CheckoutPaymentComponent_Query(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵviewQuery(_c0, 5);\n      i0.ɵɵviewQuery(_c1, 5);\n      i0.ɵɵviewQuery(_c2, 5);\n    }\n    if (rf & 2) {\n      let _t;\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardNumberElement = _t.first);\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardExpiryElement = _t.first);\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cvcElement = _t.first);\n    }\n  },\n  inputs: {\n    checkOutForm: \"checkOutForm\"\n  },\n  decls: 30,\n  vars: 2,\n  consts: [[\"class\", \"mt-4\", \"style\", \"margin-right:10px ;\", 3, \"formGroup\", 4, \"ngIf\"], [1, \"d-flex\", \"justify-content-between\", \"flex-row\", \"mb-5\"], [\"cdkStepperPrevious\", \"\", 1, \"btn\", \"btn-danger\"], [1, \"fa\", \"fa-angle-left\"], [2, \"font-weight\", \"bolder\"], [\"onmouseover\", \"this.stop();\", \"onmouseout\", \"this.start();\"], [2, \"color\", \"red\"], [2, \"color\", \"blue\", \"font-weight\", \"bolder\"], [2, \"color\", \"black\", \"font-weight\", \"bold\"], [1, \"mt-4\", 2, \"margin-right\", \"10px\", 3, \"formGroup\"], [1, \"row\"], [\"formGroupName\", \"paymentForm\", 1, \"form-group\", \"col-12\"], [\"label\", \"Name on card\", \"formControlName\", \"nameOnCard\"], [1, \"row\", \"mb-2\"], [1, \"col-6\"], [1, \"form-floating\"], [1, \"form-control\"], [\"cardNumber\", \"\"], [1, \"btn-danger\"], [1, \"col-3\"], [\"cardExpiry\", \"\"], [\"cardCvc\", \"\"], [1, \"row\", \"mt-3\", \"mb-4\", \"justify-content-center\"], [1, \"btn\", \"btn-success\", 2, \"width\", \"30%\", 3, \"disabled\", \"click\"], [\"class\", \"fa fa-spinner fa-spin\", 4, \"ngIf\"], [1, \"fa\", \"fa-spinner\", \"fa-spin\"]],\n  template: function CheckoutPaymentComponent_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵtemplate(0, CheckoutPaymentComponent_div_0_Template, 27, 4, \"div\", 0);\n      i0.ɵɵelementStart(1, \"div\", 1)(2, \"button\", 2);\n      i0.ɵɵelement(3, \"i\", 3);\n      i0.ɵɵtext(4, \" Review \");\n      i0.ɵɵelementEnd()();\n      i0.ɵɵelementStart(5, \"div\", 4)(6, \"marquee\", 5);\n      i0.ɵɵtext(7, \" Click me to pause..\");\n      i0.ɵɵelementStart(8, \"strong\", 6);\n      i0.ɵɵtext(9, \" Warning!!! \");\n      i0.ɵɵelementEnd();\n      i0.ɵɵtext(10, \" Do not use your personal card details for testing this payment. I will not be liabl for any misuse personal information. For your safety and testing purpose, use this free stripe card details: \");\n      i0.ɵɵelementStart(11, \"strong\", 7);\n      i0.ɵɵtext(12, \"Card Number: \");\n      i0.ɵɵelementStart(13, \"strong\", 8);\n      i0.ɵɵtext(14, \"4000 0027 6000 3184\");\n      i0.ɵɵelementEnd()();\n      i0.ɵɵtext(15, \" for successful or failed payment; or \");\n      i0.ɵɵelementStart(16, \"strong\", 7);\n      i0.ɵɵtext(17, \"Card Number: \");\n      i0.ɵɵelementStart(18, \"strong\", 8);\n      i0.ɵɵtext(19, \"4242 4242 4242 4242\");\n      i0.ɵɵelementEnd()();\n      i0.ɵɵtext(20, \" for pending transaction; \");\n      i0.ɵɵelementStart(21, \"strong\", 7);\n      i0.ɵɵtext(22, \"Card Expiry: \");\n      i0.ɵɵelementStart(23, \"strong\", 8);\n      i0.ɵɵtext(24);\n      i0.ɵɵelementEnd()();\n      i0.ɵɵtext(25, \"; \");\n      i0.ɵɵelementStart(26, \"strong\", 7);\n      i0.ɵɵtext(27, \"CVC: \");\n      i0.ɵɵelementStart(28, \"strong\", 8);\n      i0.ɵɵtext(29, \"123\");\n      i0.ɵɵelementEnd()()()();\n    }\n    if (rf & 2) {\n      i0.ɵɵproperty(\"ngIf\", ctx.checkOutForm);\n      i0.ɵɵadvance(24);\n      i0.ɵɵtextInterpolate1(\"01/\", ctx.yearSub + 1, \"\");\n    }\n  },\n  dependencies: [i5.NgIf, i6.NgControlStatus, i6.NgControlStatusGroup, i6.FormGroupDirective, i6.FormControlName, i6.FormGroupName, i7.TextInputsComponent, i8.CdkStepperPrevious]\n});","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}