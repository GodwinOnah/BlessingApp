{"ast":null,"code":"import _asyncToGenerator from \"/Users/godwinonah/Documents/TheBags/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { loadStripe } from '@stripe/stripe-js';\nimport { firstValueFrom } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"app/basket/basket.service\";\nimport * as i2 from \"../../checkout-service.service\";\nimport * as i3 from \"ngx-toastr\";\nimport * as i4 from \"@angular/router\";\nimport * as i5 from \"@angular/common\";\nimport * as i6 from \"@angular/forms\";\nimport * as i7 from \"../../../Account/text-inputs/text-inputs.component\";\nimport * as i8 from \"@angular/cdk/stepper\";\nconst _c0 = [\"cardNumber\"];\nconst _c1 = [\"cardExpiry\"];\nconst _c2 = [\"cardCvc\"];\nfunction CheckoutPaymentComponent_div_0_i_26_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"i\", 25);\n  }\n}\nfunction CheckoutPaymentComponent_div_0_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r6 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 9)(1, \"div\", 10)(2, \"div\", 11);\n    i0.ɵɵelement(3, \"app-text-inputs\", 12);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(4, \"div\", 13)(5, \"div\", 14)(6, \"div\", 15);\n    i0.ɵɵelement(7, \"div\", 16, 17);\n    i0.ɵɵelementStart(9, \"label\");\n    i0.ɵɵtext(10, \"Card Number\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(11, \"span\", 18);\n    i0.ɵɵtext(12);\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(13, \"div\", 19)(14, \"div\", 15);\n    i0.ɵɵelement(15, \"div\", 16, 20);\n    i0.ɵɵelementStart(17, \"label\");\n    i0.ɵɵtext(18, \"Card Expiry\");\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(19, \"div\", 19)(20, \"div\", 15);\n    i0.ɵɵelement(21, \"div\", 16, 21);\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(23, \"div\", 22)(24, \"button\", 23);\n    i0.ɵɵlistener(\"click\", function CheckoutPaymentComponent_div_0_Template_button_click_24_listener() {\n      i0.ɵɵrestoreView(_r6);\n      const ctx_r5 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r5.OrderSubmission());\n    });\n    i0.ɵɵtext(25, \" Submit \");\n    i0.ɵɵtemplate(26, CheckoutPaymentComponent_div_0_i_26_Template, 1, 0, \"i\", 24);\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵproperty(\"formGroup\", ctx_r0.checkOutForm);\n    i0.ɵɵadvance(12);\n    i0.ɵɵtextInterpolate(ctx_r0.cardErrors);\n    i0.ɵɵadvance(12);\n    i0.ɵɵproperty(\"disabled\", ctx_r0.loading || !ctx_r0.paymentIsComplete);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngIf\", ctx_r0.loading);\n  }\n}\nexport class CheckoutPaymentComponent {\n  constructor(basketService, checkOutService, toastr, router) {\n    this.basketService = basketService;\n    this.checkOutService = checkOutService;\n    this.toastr = toastr;\n    this.router = router;\n    this.errors = null;\n    this.stripe = null;\n    this.cardNumberComplete = false;\n    this.cardExpiryComplete = false;\n    this.cvcComplete = false;\n    this.loading = false;\n  }\n  ngOnInit() {\n    this.year = new Date().getFullYear();\n    this.yearSub = Number(this.year.toString().substring(2, 4));\n    loadStripe('pk_test_51Mcx2FB7QPlKfZO42IAdvFhiWvLmJJqyarpwQZYE8Mes7QioM5QNIme3OPI0KBP7tnLRf43CLRSzmCa0xzv37VmJ00VDpXrD7T').then(stripe => {\n      this.stripe = stripe;\n      const elements = stripe?.elements();\n      if (elements) {\n        this.cardNumber = elements.create('cardNumber');\n        this.cardNumber.mount(this.cardNumberElement?.nativeElement);\n        this.cardNumber.on('change', event => {\n          this.cardNumberComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;else {\n            this.cardErrors = null;\n          }\n        });\n        this.cardExpiry = elements.create('cardExpiry');\n        this.cardExpiry.mount(this.cardExpiryElement?.nativeElement);\n        this.cardExpiry.on('change', event => {\n          this.cardExpiryComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;else {\n            this.cardErrors = null;\n          }\n        });\n        this.cvc = elements.create('cardCvc');\n        this.cvc.mount(this.cvcElement?.nativeElement);\n        this.cvc.on('change', event => {\n          this.cvcComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;else {\n            this.cardErrors = null;\n          }\n        });\n      }\n    });\n  }\n  get paymentIsComplete() {\n    return this.checkOutForm.get('paymentForm')?.valid && this.cardNumberComplete && this.cardExpiryComplete && this.cvcComplete;\n  }\n  ConfirmPaymentUsingStripe(basket) {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      if (!basket) throw new Error('basket is null');\n      const result = _this.stripe?.confirmCardPayment(basket.clientSecret, {\n        payment_method: {\n          card: _this.cardNumber,\n          billing_details: {\n            name: _this.checkOutForm?.get('paymentForm')?.get('nameOnCard')?.value\n          }\n        }\n      });\n      if (!result) throw new Error('problem confirming problem with stripe');\n      return result;\n    })();\n  }\n  GetOrderDetails(basket) {\n    const shippingAddress = this.checkOutForm?.get('addressForm')?.value;\n    if (!shippingAddress) throw new Error('No Address added');\n    return {\n      basketId: basket.id,\n      deliveryId: basket.deliveryId,\n      shippingAddress: shippingAddress\n    };\n  }\n  CreateOrder(basket) {\n    var _this2 = this;\n    return _asyncToGenerator(function* () {\n      if (!basket) throw new Error('basket is null');\n      const orderToCreate = _this2.GetOrderDetails(basket);\n      return firstValueFrom(_this2.checkOutService.CreateAnOrder(orderToCreate));\n      ;\n    })();\n  }\n  OrderSubmission() {\n    var _this3 = this;\n    return _asyncToGenerator(function* () {\n      _this3.loading = true;\n      const basket = _this3.basketService.CurrentBasket();\n      if (!basket) throw new Error(\"Cannot get basket\");\n      try {\n        const createdOrder = yield _this3.CreateOrder(basket);\n        const paymentResult = yield _this3.ConfirmPaymentUsingStripe(basket);\n        if (paymentResult.paymentIntent) {\n          _this3.basketService.DeleteBasket(basket);\n          const navigationExtras = {\n            state: createdOrder\n          };\n          _this3.router.navigate(['Checkout/success'], navigationExtras);\n        } else {\n          _this3.toastr.error(paymentResult.error.message);\n        }\n      } catch (error) {\n        _this3.toastr.error(error.message);\n      } finally {\n        _this3.loading = false;\n      }\n    })();\n  }\n}\nCheckoutPaymentComponent.ɵfac = function CheckoutPaymentComponent_Factory(t) {\n  return new (t || CheckoutPaymentComponent)(i0.ɵɵdirectiveInject(i1.BasketService), i0.ɵɵdirectiveInject(i2.CheckoutServiceService), i0.ɵɵdirectiveInject(i3.ToastrService), i0.ɵɵdirectiveInject(i4.Router));\n};\nCheckoutPaymentComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: CheckoutPaymentComponent,\n  selectors: [[\"app-checkout-payment\"]],\n  viewQuery: function CheckoutPaymentComponent_Query(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵviewQuery(_c0, 5);\n      i0.ɵɵviewQuery(_c1, 5);\n      i0.ɵɵviewQuery(_c2, 5);\n    }\n    if (rf & 2) {\n      let _t;\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardNumberElement = _t.first);\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardExpiryElement = _t.first);\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cvcElement = _t.first);\n    }\n  },\n  inputs: {\n    checkOutForm: \"checkOutForm\"\n  },\n  decls: 30,\n  vars: 2,\n  consts: [[\"class\", \"mt-4\", 3, \"formGroup\", 4, \"ngIf\"], [1, \"d-flex\", \"justify-content-between\", \"flex-row\", \"mb-5\"], [\"cdkStepperPrevious\", \"\", 1, \"btn\", \"btn-danger\"], [1, \"fa\", \"fa-angle-left\"], [2, \"font-weight\", \"bolder\"], [\"onmouseover\", \"this.stop();\", \"onmouseout\", \"this.start();\"], [2, \"color\", \"red\"], [2, \"color\", \"blue\", \"font-weight\", \"bolder\"], [2, \"color\", \"black\", \"font-weight\", \"bold\"], [1, \"mt-4\", 3, \"formGroup\"], [1, \"row\"], [\"formGroupName\", \"paymentForm\", 1, \"form-group\", \"col-12\"], [\"label\", \"Name on card\", \"formControlName\", \"nameOnCard\"], [1, \"row\", \"mb-2\"], [1, \"col-6\"], [1, \"form-floating\"], [1, \"form-control\"], [\"cardNumber\", \"\"], [1, \"btn-danger\"], [1, \"col-3\"], [\"cardExpiry\", \"\"], [\"cardCvc\", \"\"], [1, \"row\", \"mt-3\", \"mb-4\", \"justify-content-center\"], [1, \"btn\", \"btn-success\", 2, \"width\", \"30%\", 3, \"disabled\", \"click\"], [\"class\", \"fa fa-spinner fa-spin\", 4, \"ngIf\"], [1, \"fa\", \"fa-spinner\", \"fa-spin\"]],\n  template: function CheckoutPaymentComponent_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵtemplate(0, CheckoutPaymentComponent_div_0_Template, 27, 4, \"div\", 0);\n      i0.ɵɵelementStart(1, \"div\", 1)(2, \"button\", 2);\n      i0.ɵɵelement(3, \"i\", 3);\n      i0.ɵɵtext(4, \" Review \");\n      i0.ɵɵelementEnd()();\n      i0.ɵɵelementStart(5, \"div\", 4)(6, \"marquee\", 5);\n      i0.ɵɵtext(7, \" Click me to pause..\");\n      i0.ɵɵelementStart(8, \"strong\", 6);\n      i0.ɵɵtext(9, \" Warning!!! \");\n      i0.ɵɵelementEnd();\n      i0.ɵɵtext(10, \" Do not use your personal card details for testing this payment. I will not be liabl for any misuse personal information. For your safety and testing purpose, use this free stripe card details: \");\n      i0.ɵɵelementStart(11, \"strong\", 7);\n      i0.ɵɵtext(12, \"Card Number: \");\n      i0.ɵɵelementStart(13, \"strong\", 8);\n      i0.ɵɵtext(14, \"4000 0027 6000 3184\");\n      i0.ɵɵelementEnd()();\n      i0.ɵɵtext(15, \" for successful or failed payment; or \");\n      i0.ɵɵelementStart(16, \"strong\", 7);\n      i0.ɵɵtext(17, \"Card Number: \");\n      i0.ɵɵelementStart(18, \"strong\", 8);\n      i0.ɵɵtext(19, \"4242 4242 4242 4242\");\n      i0.ɵɵelementEnd()();\n      i0.ɵɵtext(20, \" for pending transaction; \");\n      i0.ɵɵelementStart(21, \"strong\", 7);\n      i0.ɵɵtext(22, \"Card Expiry: \");\n      i0.ɵɵelementStart(23, \"strong\", 8);\n      i0.ɵɵtext(24);\n      i0.ɵɵelementEnd()();\n      i0.ɵɵtext(25, \"; \");\n      i0.ɵɵelementStart(26, \"strong\", 7);\n      i0.ɵɵtext(27, \"CVC: \");\n      i0.ɵɵelementStart(28, \"strong\", 8);\n      i0.ɵɵtext(29, \"123\");\n      i0.ɵɵelementEnd()()()();\n    }\n    if (rf & 2) {\n      i0.ɵɵproperty(\"ngIf\", ctx.checkOutForm);\n      i0.ɵɵadvance(24);\n      i0.ɵɵtextInterpolate1(\"01/\", ctx.yearSub + 1, \"\");\n    }\n  },\n  dependencies: [i5.NgIf, i6.NgControlStatus, i6.NgControlStatusGroup, i6.FormGroupDirective, i6.FormControlName, i6.FormGroupName, i7.TextInputsComponent, i8.CdkStepperPrevious],\n  styles: [\"\\n/*# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IiIsInNvdXJjZVJvb3QiOiIifQ== */\"]\n});","map":{"version":3,"mappings":"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","names":["loadStripe","firstValueFrom","i0","CheckoutPaymentComponent","constructor","basketService","checkOutService","toastr","router","ngOnInit","year","Date","getFullYear","yearSub","Number","toString","substring","then","stripe","elements","cardNumber","create","mount","cardNumberElement","nativeElement","on","event","cardNumberComplete","complete","error","cardErrors","message","cardExpiry","cardExpiryElement","cardExpiryComplete","cvc","cvcElement","cvcComplete","paymentIsComplete","checkOutForm","get","valid","ConfirmPaymentUsingStripe","basket","Error","result","confirmCardPayment","clientSecret","payment_method","card","billing_details","name","value","GetOrderDetails","shippingAddress","basketId","id","deliveryId","CreateOrder","orderToCreate","CreateAnOrder","OrderSubmission","loading","CurrentBasket","createdOrder","paymentResult","paymentIntent","DeleteBasket","navigationExtras","state","navigate","selectors","viewQuery"],"sourceRoot":"","sources":["/Users/godwinonah/Documents/TheBags/client/src/app/Checkout/checkouts/checkout-payment/checkout-payment.component.ts","/Users/godwinonah/Documents/TheBags/client/src/app/Checkout/checkouts/checkout-payment/checkout-payment.component.html"],"sourcesContent":["import { Component, ElementRef, Input, OnInit, ViewChild } from '@angular/core';\nimport { FormGroup } from '@angular/forms';\nimport { NavigationExtras,Router } from '@angular/router';\nimport { loadStripe, ShippingAddress, Stripe, StripeCardCvcElement, StripeCardExpiryElement, StripeCardNumberElement } from '@stripe/stripe-js';\nimport { BasketService } from 'app/basket/basket.service';\nimport { IBasket } from 'app/prodsharemod/models/IBasket';\nimport { IOrderToCreate } from 'app/prodsharemod/models/IOrderToCreate';\nimport { ToastrService } from 'ngx-toastr';\nimport { firstValueFrom } from 'rxjs';\n\nimport { CheckoutServiceService } from '../../checkout-service.service';\n\n@Component({\n  selector: 'app-checkout-payment',\n  templateUrl: './checkout-payment.component.html',\n  styleUrls: ['./checkout-payment.component.scss']\n})\nexport class CheckoutPaymentComponent implements OnInit{\n  errors : string[] | null = null;\n  @Input() checkOutForm? : FormGroup;\n  @ViewChild('cardNumber') cardNumberElement?:ElementRef;\n  @ViewChild('cardExpiry') cardExpiryElement?:ElementRef;\n  @ViewChild('cardCvc') cvcElement?:ElementRef;\n  stripe:Stripe|null=null;\n  cardNumber?:StripeCardNumberElement;\n  cardExpiry?:StripeCardExpiryElement;\n  cvc?:StripeCardCvcElement;\n  cardNumberComplete=false;\n  cardExpiryComplete=false;\n  cvcComplete=false;\n  cardErrors:any;\n  loading=false;\n  year: number;\n  yearSub:number;\n\n\n    constructor(private basketService:BasketService,\n    private checkOutService:CheckoutServiceService,\n    private toastr:ToastrService,\n    private router:Router){\n\n  }\n  ngOnInit(): void {\n    this.year = new Date().getFullYear();\n    this.yearSub = Number(this.year.toString().substring(2,4));\n   loadStripe('pk_test_51Mcx2FB7QPlKfZO42IAdvFhiWvLmJJqyarpwQZYE8Mes7QioM5QNIme3OPI0KBP7tnLRf43CLRSzmCa0xzv37VmJ00VDpXrD7T')\n   .then(stripe=>{\n    this.stripe = stripe;\n    const elements=stripe?.elements();\n    if(elements){\n      this.cardNumber = elements.create('cardNumber');\n      this.cardNumber.mount(this.cardNumberElement?.nativeElement);\n      this.cardNumber.on('change',event=>{\n        this.cardNumberComplete = event.complete;\n        if(event.error)\n            this.cardErrors=event.error.message;\n        else{this.cardErrors=null}\n      })\n      this.cardExpiry = elements.create('cardExpiry');\n      this.cardExpiry.mount(this.cardExpiryElement?.nativeElement);\n      this.cardExpiry.on('change',event=>{\n        this.cardExpiryComplete = event.complete;\n        if(event.error)\n            this.cardErrors=event.error.message;\n        else{this.cardErrors=null}\n      })\n      this.cvc = elements.create('cardCvc');\n      this.cvc.mount(this.cvcElement?.nativeElement);\n      this.cvc.on('change',event=>{\n        this.cvcComplete = event.complete;\n        if(event.error)\n            this.cardErrors = event.error.message;\n        else{this.cardErrors = null}\n      })\n    }\n   })\n  }\n\n  get paymentIsComplete(){\n   return this.checkOutForm.get('paymentForm')?.valid\n    && this.cardNumberComplete && this.cardExpiryComplete\n    && this.cvcComplete\n  }\n\n  private async ConfirmPaymentUsingStripe(basket: IBasket | null) {\n    if (!basket)throw new Error('basket is null');\n    const result =  this.stripe?.confirmCardPayment(basket.clientSecret,{\n      payment_method:{\n        card:this.cardNumber,\n        billing_details:{\n          name :this.checkOutForm?.get('paymentForm')?.get('nameOnCard')?.value\n        }\n      }});\n      if(!result)throw new Error('problem confirming problem with stripe');\n    return result;\n  }\n  \n  private GetOrderDetails(basket: IBasket):IOrderToCreate {\n  \n    const shippingAddress = this.checkOutForm?.get('addressForm')?.value as ShippingAddress;\n    if(!shippingAddress)throw new Error('No Address added');\n    \n    return{\n      basketId:basket.id,\n      deliveryId:basket.deliveryId,\n      shippingAddress:shippingAddress\n\n    }\n  }\n\n  private async CreateOrder(basket: IBasket |null) {\n\n    if (!basket)throw new Error('basket is null');\n    const orderToCreate = this.GetOrderDetails(basket);\n    return firstValueFrom(this.checkOutService.CreateAnOrder(orderToCreate));\n   ;\n  }\n\n  async OrderSubmission(){\n    this.loading=true;\n    const basket = this.basketService.CurrentBasket();\n    if (!basket) throw new Error(\"Cannot get basket\");\n    try{\n      const createdOrder = await this.CreateOrder(basket);\n      const paymentResult= await this.ConfirmPaymentUsingStripe(basket);\n      if(paymentResult.paymentIntent){\n            this.basketService.DeleteBasket(basket);\n            const navigationExtras :NavigationExtras={state:createdOrder};\n            this.router.navigate(['Checkout/success'],navigationExtras);\n          }\n          else{\n            this.toastr.error(paymentResult.error.message);     \n    }\n  }\n    catch(error){\n      this.toastr.error(error.message);\n    }\n\n    finally{\n      this.loading=false;\n    }\n  }\n}\n","<div class=\"mt-4\" *ngIf=\"checkOutForm\" [formGroup]=\"checkOutForm\">\n    <div class=\"row\">\n        <div class=\"form-group col-12\" formGroupName=\"paymentForm\">\n            <app-text-inputs label=\"Name on card\" formControlName=\"nameOnCard\"></app-text-inputs>\n        </div>\n    </div>\n    <div class=\"row mb-2\">\n        <div class=\"col-6\">\n            <div class=\"form-floating\">\n                <div class=\"form-control\" #cardNumber>\n                </div>\n                <label>Card Number</label>\n                <span class=\"btn-danger\">{{cardErrors}}</span>\n            </div>\n        </div>\n        <div class=\"col-3\">\n            <div class=\"form-floating\">\n                <div class=\"form-control\" #cardExpiry>\n                </div>\n                <label>Card Expiry</label>\n            </div>\n        </div>\n        <div class=\"col-3\">\n            <div class=\"form-floating\">\n                <div class=\"form-control\" #cardCvc>\n                </div>\n            </div>\n        </div>\n    </div>\n    <div class=\"row mt-3 mb-4 justify-content-center\" >\n        <button [disabled]=\"loading||!paymentIsComplete\" style=\"width: 30%;\" \n        class=\"btn btn-success\"  (click)=\"OrderSubmission()\">\n            Submit \n            <i *ngIf=\"loading\" class=\"fa fa-spinner fa-spin\"></i>\n         </button>\n    </div>\n</div>\n<div class=\"d-flex justify-content-between flex-row mb-5\">\n    <button class=\"btn btn-danger\" cdkStepperPrevious>\n        <i class=\"fa fa-angle-left\"></i>  Review\n    </button>\n   \n</div>\n<div style=\" font-weight: bolder;\">\n    <marquee onmouseover=\"this.stop();\" onmouseout=\"this.start();\">\n       Click me to pause..<strong style=\"color:red ;\"> Warning!!! </strong> Do not use your personal card details for testing this payment.\n        I will not be liabl for any misuse personal information.\n         For your safety and testing purpose, use this free stripe card details: \n\n        <strong style=\"color: blue; font-weight: bolder;\">Card Number: \n            <strong style=\"color: black; font-weight: bold;\">4000 0027 6000 3184</strong>\n        </strong> for successful or failed payment; \n            or \n        <strong style=\"color: blue; font-weight: bolder;\">Card Number: \n            <strong style=\"color: black; font-weight: bold;\">4242 4242 4242 4242</strong>\n        </strong> for pending transaction; \n\n        \n        <strong style=\"color: blue; font-weight: bolder;\">Card Expiry: \n            <strong style=\"color: black; font-weight: bold;\">01/{{yearSub+1}}</strong>\n        </strong>; \n\n        <strong style=\"color: blue; font-weight: bolder;\">CVC: \n            <strong style=\"color: black; font-weight: bold;\">123</strong>\n        </strong>\n    </marquee>\n</div>"]},"metadata":{},"sourceType":"module","externalDependencies":[]}